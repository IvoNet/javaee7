<!DOCTYPE html>
<!--
  ~ Copyright 2014 ivonet
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>CLIENT CERTIFICATE Security</title>
</head>
<body>

<h1>JavaEE7 JAX RS with CLIENT CERTIFICATE Authentication</h1>

<p>A CLIENT CERTIFICATE Authentication example from the "RESTFul Java Web Services Security" book.</p>

<p>In the book JBoss is used as the Application Server. In this example I use GlassFish 4.1</p>

<p>NOTE: Some commands are word wrapped but should be 1 line on the command prompt!</p>

<p>In order to get this example to work you have to do the following:</p>
<ul>
    <li>Create Certificates</li>
    <li>Try it out!</li>
</ul>

<h2>Create Certificates</h2>

<p>

    To generate these certificates you must have OpenSSL installed on your operating system, it comes installed by
    default on most like me,
    However, if you're not available, you can get the installer from this link
    http://www.openssl.org/related/binaries.html to continue creating certificates.
    Steps to generate certificates

    During this process we are going to use several passwords, some for the CA, some others for the client and some
    others for the server.
    With the purpose to avoid mistakes, let's use the default application server password changeit.
    Because of this we are going to omit the password that must be entered, since it is always the same one.

    First we have to generate the key of CA
    openssl genrsa -des3 -out ca.key 4096

    Now we are going to generate the CA certificate using the key ca.key we just created few minutes ago. Type the
    following command:
    openssl req -x509 -days 365 -new -key ca.key -out ca.crt

    Here you can enter any information you want

    What we do right now will be to generate a certificate for our application server using the CA key.
    The first step is to generate a request file with our information, so the CA uses it and generate the certificate.
    The file that contains the request is going to be generated this way:
    openssl req -new -key ca.key -out server.csr
    Here you can re-enter any information you want

    And late we generate the certificate:
    openssl x509 -req -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 001 -out server.crt

    Now we need to create a user for the application, this means, to generate another certificate. We will do it the
    same way we just explained earlier,
    so let's generate the request file:
    openssl req -new -key ca.key -out client.csr

    And now from the request file we are going to generate the certificate:
    openssl x509 -req -days 3650 -in client.csr -CA ca.crt -CAkey ca.key -set_serial 002 -out client.crt

    Obviously, the certificates are generated by the CA, but since we are the CA, we do it this way.

    Now that we have our certificates done, we should create a place where they can be stored.
    JBoss is capable of using three password storage formats: JKS, PKCS11 or PKCS12. For our example we will use PKCS12.
    The first step is to export the server certificate into this format:

    openssl pkcs12 -export -inkey ca.key -in server.crt -out server.pkcs12

    And then, through the JDK key tool let's create the password storage:
    keytool -importkeystore -destkeystore server.keystore -srckeystore server.pkcs12 -srcstoretype PKCS12


    Next, we are going to add the certificate of our CA to the JBoss certificates storage:
    keytool -importcert -alias "PacktPub" -file ca.crt -keystore server.truststore

    keytool -importcert -alias "IvoNet" -file ca.crt -keystore server.truststore


    Finally client.pkcs12 convert the file to client.pfx
    openssl pkcs12 -export -out client.pfx -inkey ca.key -in server.crt -certfile client.crt

    This file will use it later from the SOAP UI when making the request
</p>

<p>
    cp /usr/local/Cellar/glassfish/4.1/libexec/glassfish/domains/domain1/config/keystore.jks
    /Users/ivonet/dev/ivonet-home/JavaEE7/jaxrs/rest-java-web-service-security/client-certificate-authentication/src/main/resources/glassfish/keystore.jks
    cp /usr/local/Cellar/glassfish/4.1/libexec/glassfish/domains/domain1/config/cacerts.jks
    /Users/ivonet/dev/ivonet-home/JavaEE7/jaxrs/rest-java-web-service-security/client-certificate-authentication/src/main/resources/glassfish/cacerts.jks

    keytool -list -v -keystore keystore.jks -keypass changeit -storepass changeit
    keytool -list -v -alias ivonet -keystore keystore.jks -keypass changeit -storepass changeit
    keytool -delete -alias ivonet -keystore keystore.jks -keypass changeit -storepass changeit
    keytool -genkeypair -alias ivonet -keyalg RSA -keystore keystore.jks -keysize 2048 -keypass changeit -storepass
    changeit

    #keytool -genkey -alias ivonet -keyalg RSA -keypass changeit -storepass changeit -keystore keystore.jks

    keytool -export -alias ivonet -storepass changeit -file server.cer -keystore keystore.jks

    keytool -import -v -trustcacerts -alias ivonet -file server.cer -keystore cacerts.jks -keypass changeit -storepass
    changeit


    -Djavax.net.ssl.keyStore=${com.sun.aas.instanceRoot}/config/keystore.jks
    -Djavax.net.ssl.trustStore=${com.sun.aas.instanceRoot}/config/cacerts.jks


    keytool -genkey -noprompt -trustcacerts -keyalg RSA -alias ${cert.alias} -dname ${dn.name} -keypass ${key.pass}
    -keystore ${keystore.file} -storepass ${keystore.pass}
    keytool -genkey -noprompt -trustcacerts -keyalg RSA -alias ivonet -dname "cn=localhost, ou=engineering, o=ivonet,
    c=NL" -keypass changeit -keystore keystore.jks -storepass changeit
</p>

<p>
    http://localhost:8080/cert/services/persons
</p>

<h2>Try it Out</h2>

<p>TODO</p>
</body>
</html>